// Generated by moon test.

typealias () -> Unit raise Error
  as Moonbit_Test_Driver_Internal_No_Args_Function

typealias (Moonbit_Test_Driver_Internal_Test_Arg) -> Unit raise Error
  as Moonbit_Test_Driver_Internal_With_Args_Function

typealias @moonbitlang/core/builtin.Map[
  String,
  @moonbitlang/core/builtin.Map[
    Int,
    (
      Moonbit_Test_Driver_Internal_No_Args_Function,
      @moonbitlang/core/builtin.Array[String],
    ),
  ],
] as Moonbit_Test_Driver_Internal_No_Args_Map

typealias @moonbitlang/core/builtin.Map[
  String,
  @moonbitlang/core/builtin.Map[
    Int,
    (
      Moonbit_Test_Driver_Internal_With_Args_Function,
      @moonbitlang/core/builtin.Array[String],
    ),
  ],
] as Moonbit_Test_Driver_Internal_TestDriver_With_Args_Map

struct Moonbit_Test_Driver_Internal_Meta {
  filename : String
  index : Int
  attrs : @moonbitlang/core/builtin.Array[String]
}

enum Moonbit_Test_Driver_Internal__F {
  F0(Moonbit_Test_Driver_Internal_No_Args_Function)
  F1(Moonbit_Test_Driver_Internal_With_Args_Function)
}

struct Moonbit_Test_Driver_Internal__TestCase {
  f : Moonbit_Test_Driver_Internal__F
  meta : Moonbit_Test_Driver_Internal_Meta
}

let moonbit_test_driver_internal_no_args_tests : Moonbit_Test_Driver_Internal_No_Args_Map = { }  // WILL BE REPLACED
let moonbit_test_driver_internal_with_args_tests : Moonbit_Test_Driver_Internal_TestDriver_With_Args_Map = { }  // WILL BE REPLACED

fn moonbit_test_driver_internal_apply_filter(
  no_args_tests : Moonbit_Test_Driver_Internal_No_Args_Map,
  with_args_tests : Moonbit_Test_Driver_Internal_TestDriver_With_Args_Map,
  file_filter : String,
  index_filter : Int
) -> Option[Moonbit_Test_Driver_Internal__TestCase] {
  let no_args_filtered_test = match no_args_tests.get(file_filter) {
    Some(index_func_map) => {
      match index_func_map.get(index_filter) {
        Some(func_attrs_tuple) => {
          let k = {
            f: Moonbit_Test_Driver_Internal__F::F0(func_attrs_tuple.0),
            meta: { filename: file_filter, index: index_filter, attrs: func_attrs_tuple.1 },
          }
          Some(k)
        }
        _ => None
      }
    }
    _ => None
  }

  let with_args_filtered_test = match with_args_tests.get(file_filter) {
    Some(index_func_map) => {
      match index_func_map.get(index_filter) {
        Some(func_attrs_tuple) => {
          let k = {
            f: Moonbit_Test_Driver_Internal__F::F1(func_attrs_tuple.0),
            meta: { filename: file_filter, index: index_filter, attrs: func_attrs_tuple.1 },
          }
          Some(k)
        }
        _ => None
      }
    }
    _ => None
  }


  if no_args_filtered_test is Some(_) {
    no_args_filtered_test
  } else {
    with_args_filtered_test
  }
}

pub fn moonbit_test_driver_internal_do_execute(filename : String, index : Int) -> Unit {
  let filtered_test = moonbit_test_driver_internal_apply_filter(
    moonbit_test_driver_internal_no_args_tests,
    moonbit_test_driver_internal_with_args_tests,
    filename,
    index
  )
  let mut test_name = ""
  let mut file_name = ""
  let mut message = ""

  match filtered_test {
    Some(item) => {
      let attrs = item.meta.attrs
      file_name = item.meta.filename
      let name = if attrs.is_empty() { "" } else { attrs[0] }
      let name = if name.length() == 0 {
        item.meta.index.to_string()
      } else {
        name
      }

      if MOONBIT_TEST_DRIVER_INTERNAL_IS_NATIVE && attrs.iter().any(fn(attr) -> Bool {
        attr.length() >= 5 && attr[0] == 'p' && attr[1] == 'a' && attr[2] == 'n' && attr[3] == 'i' && attr[4] == 'c'
      }) {
        @moonbitlang/core/builtin.println("skipped test block: \{file_name}: \{attrs[0]}")
        @moonbitlang/core/builtin.println("{BEGIN_MOONTEST}")
        @moonbitlang/core/builtin.println(
          "{\"package\": \"{PACKAGE}\", \"filename\": \{file_name.escape()}, \"index\": \"\{index}\", \"test_name\": \{name.escape()}, \"message\": \"skipped test\"}",
        )
        @moonbitlang/core/builtin.println("{END_MOONTEST}")
        return
      }
      test_name = name

      try {
        match item.f {
          Moonbit_Test_Driver_Internal__F::F0(f) => f()
          Moonbit_Test_Driver_Internal__F::F1(f) =>
            f(moonbit_test_driver_internal_new_test_arg(name))
        }
      } catch {
        @moonbitlang/core/builtin.Failure(e) | @moonbitlang/core/builtin.InspectError(e) | @moonbitlang/core/builtin.SnapshotError(e) => {
          message = e
        }
        e => {
          message = moonbit_test_driver_internal_error_to_string(e)
        }
      }

      // In WASM, this function is called by the external test driver, but here
      // in native mode there's nothing that calls it, so we call it manually.
      if MOONBIT_TEST_DRIVER_INTERNAL_IS_NATIVE {
        // {COVERAGE_END}
      }
    }
    _ => { message = "skipped test" }
  }

  let file_name = file_name.escape()
  let test_name = test_name.escape()
  let message = message.escape()
  @moonbitlang/core/builtin.println("{BEGIN_MOONTEST}")
  @moonbitlang/core/builtin.println(
    "{\"package\": \"{PACKAGE}\", \"filename\": \{file_name}, \"index\": \"\{index}\", \"test_name\": \{test_name}, \"message\": \{message}}",
  )
  @moonbitlang/core/builtin.println("{END_MOONTEST}")
}
